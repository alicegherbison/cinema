<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><![endif]-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Cutive+Mono" rel="stylesheet">
  <style>
    body {
      font-family: 'Curtive Mono', monospace;
    }
    
    table {
      margin-top: 20px;
    }
    
    th {
      padding: 10px 10px 10px 0;
    }
    
    tr:not(:last-of-type) {
      border-bottom: 1px solid #ddd;
    }
    
    td {
      padding: 10px 0 10px 20px;
    }
  </style>
  <title>Cinema</title>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-7">
        <div class="card mt-4 mb-2">
          <div class="card-body">
            <h1>FILM FINDER</h1>
            <p>A small page for displaying upcoming films at Cineworld Fountainpark, Edinburgh.</p>
            <hr/>
            <form>
              <div class="form-group">
                <label for="key">Key</label>
                <input id="key" type="text" class="form-control" required>
              </div>
              <div id="searchBtn" class="btn btn-primary">Get film times</div>
            </form>
          </div>
        </div>
        <ul id="searchOutput"></ul>
        <section></section>
      </div>
    </div>
  </div>
  <script>
    
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    function addZero(i) {
      if (i < 10) {
        i = "0" + i;
      }
      return i;
    }
    
    function searchEvents() {
      var key = document.querySelector('#key').value;
      var headers = new Headers();
      headers.set('Authorization', 'Bearer '+ key);
      fetch('https://api.list.co.uk/v1/events?place_id=418fdadd-4f1e-b60e-03e0-bcc4000031d6&tags=film', { headers: headers })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        var films = document.querySelector('section');
        films.innerHTML = '';
        data.forEach(function(film) {
          var storeDay;
          var dailyTimes;
          
          var filmName = document.createElement('h2');
          filmName.innerHTML = film.name;
          
          var showtimes = document.createElement('table');
          
          var showtimesData = film.schedules[0].performances;
          
          showtimesData.forEach(function(performance) {
            console.log(filmName);
            console.log(performance);
            if(performance.hasOwnProperty('properties')) {
              var thing = performance.properties;
              if(thing.hasOwnProperty('event.film.3d')){
                console.log('This may be a 3d film');
                return; 
              }
              
            }
            var showing = new Date(performance.ts);
            
            var showingDay = days[showing.getDay()];
            var showingDate = addZero(showing.getDate());
            var showingMonth = months[showing.getMonth()];
            var showingYear = showing.getYear();
            var showingHour = addZero(showing.getHours());
            var showingMinutes = addZero(showing.getMinutes());
            
            var date = document.createElement('th');
            date.innerHTML = showingDay + ' ' + showingDate + ' ' + showingMonth;
            
            var showtime = document.createElement('td');
            showtime.innerHTML = showingHour + ':' + showingMinutes;
            
            if (storeDay != showingDay) {
              dailyTimes = document.createElement('tr');
              dailyTimes.prepend(date);
            }
            
            dailyTimes.appendChild(showtime);
            showtimes.appendChild(dailyTimes);
            
            storeDay = days[showing.getDay()];
          });
          
          {{/*  filmTimes.appendChild(filmName);
            filmTimes.appendChild(showtimes);  */}}
            {{/*  films.appendChild(filmTimes);  */}}
            
            var filmCard = `
            <div class="card mb-2">
              <div class="card-body">
                ${filmName.outerHTML}
                ${showtimes.outerHTML}
              </div>
            </div>
            `;
            
            films.innerHTML += filmCard;
          });
        });
      }
      document.querySelector('#searchBtn')
      .addEventListener('click', searchEvents);
    </script>
  </body>
  </html>