<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><![endif]-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" media="screen">
  <link href="https://fonts.googleapis.com/css?family=Cutive+Mono" rel="stylesheet">
  <style>
    @media screen {
      body {
        font-family: 'Curtive Mono', monospace;
      }
      
      table {
        margin-top: 20px;
      }
      
      th {
        padding: 10px 10px 10px 0;
      }
      
      tr:not(:last-of-type) {
        border-bottom: 1px solid #ddd;
      }
      
      td {
        padding: 10px 0 10px 20px;
      }
    }
    
    @media print {
      body {
        font-family: 'Curtive Mono', monospace;
      }
      header, footer, #print, .card-footer, .no-print {
        display: none;
      }
    }
    
  </style>
  <title>Film Finder</title>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col">
        <header>
          <div class="card mt-4 mb-2">
            <div class="card-body">
              <h1>FILM FINDER</h1>
              <p>A small page for displaying upcoming films at Cineworld Fountainpark, Edinburgh.</p>
              <hr/>
              <form>
                <div class="form-group">
                  <label for="key">Key</label>
                  <input id="key" type="text" class="form-control" required>
                </div>
                <div id="go" class="btn btn-primary">Get film times</div>
              </form>
            </div>
          </div>
        </header>
        <section id="results"></section>
        <footer class="mt-4 mb-4">built by <a href="https://www.alicegherbison.com">alice</a>. source on <a href="https://www.github.com/alicegherbison/cinema">github</a>.</footer>
      </div>
    </div>
  </div>
  <script>
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const submit = document.querySelector('#go');
    
    function addZero(x) {
      if (x < 10) {
        x = "0" + x;
      }
      return x;
    }
    
    function ignoreSubtitled(performance) {
      if(!(performance.hasOwnProperty('properties') && performance.properties.hasOwnProperty('event.film.subtitled'))) {
        return true;
      }
    }
    
    function getFilms() {
      const key = document.querySelector('#key').value;
      const headers = new Headers();
      
      headers.set('Authorization', 'Bearer ' + key);
      
      fetch('https://api.list.co.uk/v1/events?place_id=418fdadd-4f1e-b60e-03e0-bcc4000031d6&tags=film', { headers: headers })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        const results = document.querySelector('#results');
        results.innerHTML = '';
        
        data.forEach(function(film) {
          let storeDay;
          let dailyTimes;
          let storeTime = 0;
          const showtimes = document.createElement('table');
          const showtimesData = film.schedules[0].performances;
          
          showtimesData.filter(ignoreSubtitled).forEach(function(performance)  {            
            const showing = new Date(performance.ts);     
            const showingDay = days[showing.getDay()];
            const showingDate = addZero(showing.getDate());
            const showingMonth = months[showing.getMonth()];
            const showingHour = addZero(showing.getHours());
            const showingMinutes = addZero(showing.getMinutes());
            const dateText = document.createElement('th');
            const timeText = document.createElement('td');
            
            dateText.innerHTML = showingDay + ' ' + showingDate + ' ' + showingMonth;
            timeText.innerHTML = showingHour + ':' + showingMinutes;            
            
            if (storeDay != showingDay) {
              dailyTimes = document.createElement('tr');
              dailyTimes.prepend(dateText);
              storeTime = 0;
            }
            
            if (storeTime === 7) {
              dailyTimes = document.createElement('tr');
              dailyTimes.insertAdjacentHTML('afterbegin', '<td></td>');
              if (dailyTimes.previousSibling) {
                dailyTimes.previousSibling.style.borderBottom = 'none';
              };              
              //dailyTimes.previousSibling.style.borderBottom('none');
              storeTime = 0;
            }
            
            dailyTimes.appendChild(timeText);
            showtimes.appendChild(dailyTimes);
            
            storeTime += 1;
            storeDay = days[showing.getDay()];
          });
          
          const filmCard = /*html*/`
          <div class="film card mb-2" data-id="${film.event_id}">
            <div class="card-body">
              <h2>${film.name}</h2>
              <div class="table-responsive">
                ${showtimes.outerHTML}
              </div>
            </div>
            <div class="card-footer text-muted">
              <div class="form-check">
                <input type="checkbox" class="check-print form-check-input" id="${film.event_id}" data-id="${film.event_id}" />
                <label class="form-check-label" for="${film.event_id}">print</label>
              </div>
            </div>
          </div>
          `;
          results.innerHTML += filmCard;
        });
        results.innerHTML += /*html*/`
        <div class="text-center mt-4"><a href="javascript:window.print()" id="print" class="btn btn-primary">print</a></div>
        `;
      });
    }
        
    function prepareForPrint() {
      let anyChecked = false;
      const all = document.querySelectorAll('.check-print');
      const checked = document.querySelectorAll('.check-print:checked');
      const unchecked = document.querySelectorAll('.check-print:not(:checked');
      
      all.forEach((checkbox) => {
        if(checkbox.checked === true) {
          anyChecked = true;
        }
      })
      
      checked.forEach((checkbox) => {
        const id = checkbox.getAttribute('data-id');
        const film = document.querySelector(`.film[data-id="${id}"]`);
        
        if(film.classList.contains('no-print')) {
          film.classList.remove('no-print');
        }
      });
      
      unchecked.forEach((checkbox) => {
        const id = checkbox.getAttribute('data-id');
        const film = document.querySelector(`.film[data-id="${id}"]`);
        
        if (anyChecked === true) {
          film.classList.add('no-print');
        }
        
        if (anyChecked === false && film.classList.contains('no-print')){
          film.classList.remove('no-print');
        }
      });
    };
    
    // webkit
    if (window.matchMedia) {
      const mediaQueryList = window.matchMedia('print');
      mediaQueryList.addListener(function(mql) {
        if (mql.matches) {
          prepareForPrint();
        }
      });
    }
    
    // ie, firefox
    window.onbeforeprint = prepareForPrint;

    submit.addEventListener('click', getFilms);
  </script>
</body>
</html>